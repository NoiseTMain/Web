<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rozpis služeb - Obořiště</title>

<!-- Ikony & knihovny -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --accent2: #10b981;
    --glass: rgba(255,255,255,0.6);
    --border: rgba(0,0,0,0.06);
    --text: #0f1724;
    --danger: #ef4444;
  }
  [data-theme='dark']{
    --bg: #05060a;
    --card: rgba(20,25,30,0.6);
    --muted: #bfc8d2;
    --accent: #1e40af;
    --accent2: #047857;
    --glass: rgba(255,255,255,0.02);
    --border: rgba(255,255,255,0.06);
    --text: #fdf6e3;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:Inter, "Segoe UI", Tahoma, sans-serif;
    background: linear-gradient(180deg,var(--bg), #eef2ff);
    color: var(--text);
    padding-bottom:40px;
    transition:all .25s;
    position:relative;
    overflow-x:hidden;
  }
  [data-theme='dark'] body{ background: radial-gradient(circle at 10% 10%, #071028 0%, #04050a 60%); }

  header{
    position: relative;
    z-index: 5;
    background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    padding:20px 18px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    border-bottom:14px solid rgba(230,230,230,0.9);
    color: var(--text);
  }
  .title{ display:flex; flex-direction:column; z-index:5; }
  .title h1{ font-size:20px; margin-bottom:4px; }
  .title .sub{ font-size:12px; color:var(--muted) }

  .wrap{max-width:1100px;margin:16px auto;padding:0 18px; position:relative; z-index:5}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .controls{display:flex;gap:8px;align-items:center}

  .card{
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-shadow: 0 8px 30px rgba(15,23,42,0.06);
    border:1px solid var(--border);
    transition:transform .18s ease, box-shadow .18s ease, background .25s;
    backdrop-filter: blur(6px);
  }
  .card + .card{ margin-top:14px }
  .card:hover{ transform: translateY(-4px); box-shadow:0 18px 40px rgba(2,6,23,0.08) }

  .nav{ display:flex; gap:8px; background:transparent; padding:6px; border-radius:10px; }
  .nav button{ background:transparent; border:1px solid var(--border); padding:8px 12px; border-radius:8px; cursor:pointer; color:var(--muted); font-weight:700; }
  .nav button.active{ background:linear-gradient(90deg,var(--accent),#2b6ef6); color:#fff; border-color:transparent; }

  .form-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  input[type=text], input[type=date], select{
    padding:10px 12px; border-radius:8px; border:1px solid var(--border); min-width:150px; background:transparent; color:var(--text);
  }
  .btn{ display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border-radius:10px; border:none; background:var(--accent); color:#fff; cursor:pointer; font-weight:700; }
  .btn.secondary{ background:transparent; color:var(--muted); border:1px solid var(--border); font-weight:700; }
  .btn.danger{ background:linear-gradient(90deg,var(--danger),#b91c1c); }

  .student-list{ list-style:none; margin-top:10px; display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; padding:0; }
  .student-item{ display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; border:1px solid var(--border); background:linear-gradient(180deg,var(--glass),transparent); }
  .student-item .name{ font-weight:700; color:var(--text); cursor:pointer; text-decoration:underline; }
  .student-item .meta{ margin-left:auto; display:flex; gap:8px; align-items:center }

  .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:linear-gradient(90deg,var(--accent2),#34d399); color:#fff; font-weight:700; font-size:0.8em; }

  .table-wrap{ overflow:auto; margin-top:8px }
  table.main{ width:100%; border-collapse:collapse; min-width:720px; background:var(--card); border-radius:8px; overflow:hidden; }
  table.main thead th{ text-align:left; padding:12px; background:var(--accent); color:#fff; font-weight:800; font-size:0.95em; }
  table.main tbody td{ padding:12px; border-bottom:1px dashed rgba(0,0,0,0.06); vertical-align:middle; color:var(--text) }
  table.main tr:hover td{ background:linear-gradient(90deg, rgba(0,0,0,0.02), transparent); }

  .muted{ color:var(--muted); font-size:0.88em; }
  .date-display{ text-align:right; margin-bottom:10px; color:var(--muted); font-weight:700; }

  .exports{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; align-items:center; }
  .exports button{ padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background:linear-gradient(90deg,var(--accent),#2b6ef6); color:#fff; font-weight:700; }

  /* modal */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .modal{ width:520px; max-width:96%; background:var(--card); border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
  .modal h3{ margin-bottom:8px }
  .modal .row{ display:flex; gap:8px; align-items:center; margin-bottom:8px }
  .modal label{ font-weight:700; font-size:0.9em }

  @media(max-width:820px){
    .topbar{ flex-direction:column; gap:8px; align-items:stretch }
    .form-row{ flex-direction:column; align-items:stretch }
    table.main{ min-width:600px }
  }
</style>
</head>
<body data-theme="light">

<header>
  <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;width:100%">
    <div class="title">
      <h1>Rozpis služeb - Obořiště</h1>
      <div class="sub muted">Plánovač směn kuchyně — moderně a přehledně</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="todayShort" class="muted"></div>
      <button class="btn secondary" onclick="toggleTheme()" id="themeBtn"><i class="fa fa-moon"></i> Přepnout motiv</button>
    </div>
  </div>
</header>

<main class="wrap">

  <div class="topbar">
    <div class="nav card" role="navigation" aria-label="Sekce">
      <button class="active" data-section="schedule" onclick="showSection(event)">Rozpis</button>
      <button data-section="ratings" onclick="showSection(event)">Hodnocení</button>
      <button data-section="stats" onclick="showSection(event)">Statistiky</button>
      <button data-section="settings" onclick="showSection(event)">Nastavení</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="card" style="display:flex;gap:8px;align-items:center">
        <div class="muted">Filtr - Od</div>
        <input type="date" id="filterFrom" />
        <div class="muted">Do</div>
        <input type="date" id="filterTo" />
        <button class="btn secondary" onclick="applyFilter()">Aplikovat</button>
      </div>
    </div>
  </div>

  <!-- SECTION: Rozpis -->
  <section id="section-schedule">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2>Rozpis směn</h2>
          <div class="muted">Vyber startovní datum a počet týdnů. Rotace probíhá cyklicky. Žáci nejsou předvyplnění — přidej je tlačítkem.</div>
        </div>
        <div class="controls">
          <input type="text" id="newStudent" placeholder="Jméno žáka (např. Jan Novák)"/>
          <button class="btn" onclick="addStudent()"><i class="fa fa-plus"></i> Přidat</button>
        </div>
      </div>

      <div class="form-row" style="margin-top:14px">
        <div class="muted">Generovat od:</div>
        <input type="date" id="genFrom" />
        <div class="muted">Počet týdnů:</div>
        <select id="genWeeks">
          <option value="4">4</option>
          <option value="8">8</option>
          <option value="12">12</option>
          <option value="24">24</option>
        </select>
        <button class="btn secondary" onclick="generateNow()"><i class="fa fa-sync-alt"></i> Vygenerovat</button>
      </div>
    </div>

    <div class="card" id="scheduleCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 class="muted">Tabulka rozpisu</h3>
          <div class="muted">Klikni na jméno žáka pro otevření profilu. Nemocní se automaticky přeskočí.</div>
        </div>
        <div class="muted">Počet žáků: <span id="studentCount" class="highlight">0</span></div>
      </div>

      <div class="table-wrap">
        <table class="main" id="mainTable">
          <thead>
            <tr><th>Od</th><th>Do</th><th>Žák</th><th>Poznámka</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="exports" style="justify-content:space-between">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="alt" onclick="exportPNG(true)"><i class="fa fa-file-image"></i> PNG (čistě)</button>
          <button onclick="exportJPG()"><i class="fa fa-image"></i> JPG</button>
          <button onclick="exportPDF()"><i class="fa fa-file-pdf"></i> PDF</button>
          <button class="docx" onclick="exportDOCX()"><i class="fa fa-file-word"></i> DOCX</button>
          <button onclick="sendScheduleEmail()"><i class="fa fa-envelope"></i> Odeslat rozpis (mailto)</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted">Řadit podle:</div>
          <select id="sortSelect" onchange="applySort()">
            <option value="date">Datum</option>
            <option value="student_asc">Žák A→Z</option>
            <option value="student_desc">Žák Z→A</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- SECTION: Hodnocení -->
  <section id="section-ratings" style="display:none">
    <div class="card">
      <h2>Hodnocení žáků</h2>
      <div class="muted">Klikni na hvězdičky u žáka pro jeho hodnocení (1–5).</div>
      <div style="margin-top:12px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="muted">Řadit podle:</div>
          <select id="ratingSort" onchange="renderRatings()">
            <option value="default">Výchozí pořadí</option>
            <option value="rating_desc">Hodnocení (nejlepší)</option>
            <option value="rating_asc">Hodnocení (nejhorší)</option>
            <option value="count_desc">Počet úklidů (nejvíce)</option>
          </select>
        </div>

        <div id="ratingsList" class="student-list" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- SECTION: Statistiky -->
  <section id="section-stats" style="display:none">
    <div class="card">
      <h2>Statistiky úklidů</h2>
      <div class="muted">Vyber období a spočítej, kolikrát měl kdo úklid v tomto období.</div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <div class="muted">Od</div><input type="date" id="statFrom" />
        <div class="muted">Do</div><input type="date" id="statTo" />
        <button class="btn secondary" onclick="computeStats()">Spočítat</button>
      </div>

      <div class="stat-list" id="statCards" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- SECTION: Nastavení -->
  <section id="section-settings" style="display:none">
    <div class="card">
      <h2>Nastavení</h2>
      <p class="muted">Data se ukládají do prohlížeče (localStorage). Zde můžeš exportovat všechna data jako JSON nebo vše smazat.</p>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" onclick="exportAllJSON()"><i class="fa fa-download"></i> Exportovat data (JSON)</button>
        <button class="btn secondary" onclick="clearAll()"><i class="fa fa-trash"></i> Vymazat data</button>
      </div>
    </div>
  </section>

</main>

<!-- PROFILE MODAL -->
<div id="profileModal" style="display:none"></div>

<script>
/* =========================
   Storage & data model
   ========================= */
const LS_KEY = 'uklid_oboriste_v5'; // upravené klíče verze
const LS_RATING = 'uklid_oboriste_ratings_v5';

let store = {
  students: [], // každý student: { name, note, sick: [{from, to?}], meta? }
  ratings: {},  // name -> rating (1..5)
};

function loadStore(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) store = JSON.parse(raw);
    const rawR = localStorage.getItem(LS_RATING);
    if(rawR) store.ratings = JSON.parse(rawR);
  }catch(e){
    console.warn('Load error',e);
  }
}
function saveStore(){
  localStorage.setItem(LS_KEY, JSON.stringify(store));
  localStorage.setItem(LS_RATING, JSON.stringify(store.ratings||{}));
}

/* helpers */
function $(id){return document.getElementById(id)}
function formatDate(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleDateString('cs-CZ'); }
function isoDate(d){ if(!d) return ''; return (new Date(d)).toISOString().slice(0,10); }
function todayShort(){ const n = new Date(); $('todayShort').textContent = n.toLocaleDateString('cs-CZ'); }

/* nav */
function showSection(e){
  const btn = e.currentTarget;
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const sec = btn.getAttribute('data-section');
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  $('section-'+sec).style.display = '';
}

/* student UI */
function renderStudentsList(){
  const listContainer = document.createElement('div');
  listContainer.className = 'student-list';

  (store.students||[]).forEach((sObj, idx)=>{
    const item = document.createElement('div'); item.className = 'student-item';
    const avatar = document.createElement('div'); avatar.style.width='44px'; avatar.style.height='44px'; avatar.style.borderRadius='8px';
    avatar.style.display='flex'; avatar.style.alignItems='center'; avatar.style.justifyContent='center';
    const color = pickColor(sObj.name);
    avatar.style.background = `linear-gradient(135deg, ${color}, ${shadeColor(color, -12)})`;
    avatar.style.color='#fff'; avatar.style.fontWeight='700';
    avatar.textContent = sObj.name.split(' ').map(p=>p[0]).slice(0,2).join('');
    item.appendChild(avatar);

    const info = document.createElement('div'); info.style.marginLeft='8px';
    const nm = document.createElement('div'); nm.className='name'; nm.textContent = sObj.name;
    nm.onclick = ()=> openProfile(sObj.name);
    const note = document.createElement('div'); note.className='muted'; note.textContent = sObj.note || '';
    info.appendChild(nm); info.appendChild(note);
    item.appendChild(info);

    const meta = document.createElement('div'); meta.className='meta';

    // sickness badge (if currently sick)
    if(isCurrentlySick(sObj)){
      const b = document.createElement('span'); b.className='badge'; b.style.marginRight='6px';
      b.textContent = 'Nemocný';
      meta.appendChild(b);
    }

    // rating stars
    const stars = document.createElement('div'); stars.className='stars';
    const r = store.ratings[sObj.name] || 0;
    for(let k=1;k<=5;k++){
      const i = document.createElement('i'); i.className = 'star fa fa-star ' + (k<=r ? '' : 'inactive');
      i.dataset.index = k;
      i.onclick = (ev)=>{ ev.stopPropagation(); setRating(sObj.name, k); };
      stars.appendChild(i);
    }
    meta.appendChild(stars);

    // delete
    const del = document.createElement('button'); del.className = 'btn secondary'; del.style.marginLeft='8px';
    del.innerHTML = '<i class="fa fa-trash"></i>';
    del.onclick = (ev)=>{ ev.stopPropagation(); if(confirm('Smazat žáka?')){ store.students.splice(idx,1); delete store.ratings[sObj.name]; saveStore(); redrawAll(); } };
    meta.appendChild(del);

    item.appendChild(meta);
    listContainer.appendChild(item);
  });

  // place into schedule card (under controls)
  const schedFirstCard = document.querySelector('#section-schedule .card');
  let existingList = schedFirstCard.querySelector('.student-list');
  if(existingList) existingList.replaceWith(listContainer.cloneNode(true));
  else schedFirstCard.appendChild(listContainer.cloneNode(true));

  // ratings section
  $('ratingsList').innerHTML = '';
  $('ratingsList').appendChild(listContainer.cloneNode(true));

  // update counters
  $('studentCount').textContent = store.students.length;
}

/* ratings */
function setRating(name, value){
  store.ratings[name] = value;
  saveStore();
  renderStudentsList();
}
function renderRatings(){
  const sort = $('ratingSort') ? $('ratingSort').value : 'default';
  let arr = [...store.students];
  if(sort === 'rating_desc') arr.sort((a,b)=>(store.ratings[b.name]||0)-(store.ratings[a.name]||0));
  if(sort === 'rating_asc') arr.sort((a,b)=>(store.ratings[a.name]||0)-(store.ratings[b.name]||0));
  if(sort === 'count_desc') {
    const counts = {};
    const weeks = 52;
    const assigns = generateAssignmentsFor(new Date(), weeks);
    assigns.forEach(a=> counts[a.student] = (counts[a.student]||0)+1);
    arr.sort((a,b)=>(counts[b.name]||0)-(counts[a.name]||0));
  }
  const container = $('ratingsList'); container.innerHTML = '';
  arr.forEach(sObj=>{
    const item = document.createElement('div'); item.className = 'student-item';
    const avatar = document.createElement('div'); avatar.style.width='44px'; avatar.style.height='44px'; avatar.style.borderRadius='8px';
    avatar.style.display='flex'; avatar.style.alignItems='center'; avatar.style.justifyContent='center';
    const color = pickColor(sObj.name);
    avatar.style.background = `linear-gradient(135deg, ${color}, ${shadeColor(color, -12)})`;
    avatar.style.color='#fff'; avatar.style.fontWeight='700';
    avatar.textContent = sObj.name.split(' ').map(p=>p[0]).slice(0,2).join('');
    item.appendChild(avatar);

    const info = document.createElement('div'); info.style.marginLeft='8px';
    const nm = document.createElement('div'); nm.className='name'; nm.textContent = sObj.name;
    nm.onclick = ()=> openProfile(sObj.name);
    info.appendChild(nm);
    item.appendChild(info);

    const meta = document.createElement('div'); meta.className='meta';
    const rating = store.ratings[sObj.name] || 0;
    const stars = document.createElement('div'); stars.className='stars';
    for(let k=1;k<=5;k++){
      const i = document.createElement('i'); i.className = 'star fa fa-star ' + (k<=rating ? '' : 'inactive');
      i.onclick = (ev)=>{ ev.stopPropagation(); setRating(sObj.name, k); renderRatings(); };
      stars.appendChild(i);
    }
    meta.appendChild(stars);
    item.appendChild(meta);
    container.appendChild(item);
  });
}

/* sickness helpers */
function parseISO(d){ if(!d) return null; try { return new Date(d + 'T00:00:00'); } catch(e){ return new Date(d); } }
function isDateInRange(date, fromISO, toISO){
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const from = fromISO ? new Date(parseISO(fromISO).getFullYear(), parseISO(fromISO).getMonth(), parseISO(fromISO).getDate()) : null;
  const to = toISO ? new Date(parseISO(toISO).getFullYear(), parseISO(toISO).getMonth(), parseISO(toISO).getDate()) : null;
  if(!from) return false;
  if(to) return (d >= from && d <= to);
  return d >= from;
}
function isCurrentlySick(student){
  if(!student || !student.sick || !student.sick.length) return false;
  const now = new Date();
  return student.sick.some(p => {
    const from = p.from; const to = p.to || null;
    return isDateInRange(now, from, to);
  });
}

/* assignments generation with sickness-aware rotation */
function generateAssignmentsFor(startDate, weeks){
  const out = [];
  const students = store.students.map(s=>s.name);
  if(students.length === 0) return out;

  // We'll maintain a 'baseIndex' which is the rotating pointer.
  // For each week, we try to assign the student at baseIndex; if that student is sick during that week, we skip them
  // (they keep their position in the cycle but miss the week). The next non-sick student becomes assigned and
  // the pointer advances by 1 relative to the original cycle.
  let baseIndex = 0;
  const start = new Date(startDate);
  for(let w=0; w<weeks; w++){
    const sd = new Date(start.getFullYear(), start.getMonth(), start.getDate() + w*7);
    const ed = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate() + 6);

    // attempt to find a candidate, but we preserve the idea that pointer advances as if each week consumed one slot in the cycle
    // (so sick students "miss" their turns).
    let attempts = 0;
    let chosen = null;
    let tryIndex = baseIndex % students.length;
    while(attempts < students.length){
      const candidateName = students[tryIndex];
      const studentObj = store.students.find(s => s.name === candidateName);
      const sickThisWeek = studentObj && studentObj.sick && studentObj.sick.some(p => {
        // if sick period overlaps with any day of the week [sd..
