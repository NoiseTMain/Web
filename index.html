<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Rozpis služeb - Obořiště</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --accent2: #10b981;
    --glass: rgba(255,255,255,0.6);
    --border: rgba(0,0,0,0.06);
    --text: #0f1724;
    --danger: #ef4444;
  }
  [data-theme='dark']{
    --bg: #05060a;
    --card: rgba(20,25,30,0.6);
    --muted: #bfc8d2;
    --accent: #1e40af;
    --accent2: #047857;
    --glass: rgba(255,255,255,0.02);
    --border: rgba(255,255,255,0.06);
    --text: #fdf6e3; /* krémová barva textu v dark modu */
    --danger: #dc2626;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{
    height:100%;
    /* ZAKÁZÁNÍ SCROLLOVÁNÍ NA MOBILU */
    overflow-x: hidden; 
  }
  body{
    font-family:Inter, "Segoe UI", Tahoma, sans-serif;
    background: linear-gradient(180deg,var(--bg), #eef2ff);
    color: var(--text);
    padding-bottom:40px;
    transition:all .25s;
    position:relative;
    overflow-x:hidden;
  }
  [data-theme='dark'] body{ background: radial-gradient(circle at 10% 10%, #071028 0%, #04050a 60%); }

  /* starfield canvas sits behind content in dark mode */
  #starfield {
    position: fixed;
    left: 0; top: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0;
    opacity: 0;
    transition: opacity 0.4s ease;
  }
  [data-theme='dark'] #starfield { opacity: 1; }

  /* header with marble border */
  header{
    position: relative;
    z-index: 5;
    background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    padding:20px 18px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    border-bottom:14px solid rgba(230,230,230,0.9);
    border-image: url('https://www.transparenttextures.com/patterns/marble.png') 30 repeat;
    color: var(--text);
  }
  .title{ display:flex; flex-direction:column; z-index:5; }
  .title h1{ font-size:20px; margin-bottom:4px; }
  .title .sub{ font-size:12px; color:var(--muted) }

  .wrap{max-width:1100px;margin:16px auto;padding:0 18px; position:relative; z-index:5}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .controls{display:flex;gap:8px;align-items:center}

  .card{
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-shadow: 0 8px 30px rgba(15,23,42,0.06);
    border:1px solid var(--border);
    transition:transform .18s ease, box-shadow .18s ease, background .25s;
    backdrop-filter: blur(6px);
  }
  .card + .card{ margin-top:14px }
  .card:hover{ transform: translateY(-4px); box-shadow:0 18px 40px rgba(2,6,23,0.08) }

  /* nav */
  .nav{ display:flex; gap:8px; background:transparent; padding:6px; border-radius:10px; }
  .nav button{ background:transparent; border:1px solid var(--border); padding:8px 12px; border-radius:8px; cursor:pointer; color:var(--muted); font-weight:700; }
  .nav button.active{ background:linear-gradient(90deg,var(--accent),#2b6ef6); color:#fff; border-color:transparent; }

  /* forms */
  .form-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  input[type=text], input[type=date], select, textarea{
    padding:10px 12px; border-radius:8px; border:1px solid var(--border); min-width:150px; background:transparent; color:var(--text);
  }
  .btn{ display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border-radius:10px; border:none; background:var(--accent); color:#fff; cursor:pointer; font-weight:700; }
  .btn.secondary{ background:transparent; color:var(--muted); border:1px solid var(--border); font-weight:700; }
  .btn.danger{ background:var(--danger); color:#fff; }

  /* student list */
  .student-list{ list-style:none; margin-top:10px; display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; padding:0; }
  .student-item{ display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; border:1px solid var(--border); background:linear-gradient(180deg,var(--glass),transparent); cursor:pointer; }
  .student-item:hover{ background:linear-gradient(180deg, rgba(255,255,255,0.8), transparent); }
  [data-theme='dark'] .student-item:hover{ background:linear-gradient(180deg, rgba(255,255,255,0.05), transparent); }
  .student-item .name{ font-weight:700; color:var(--text) }
  .student-item .meta{ margin-left:auto; display:flex; gap:8px; align-items:center }

  /* table */
  .table-wrap{ overflow:auto; margin-top:8px }
  table.main{ width:100%; border-collapse:collapse; min-width:720px; background:var(--card); border-radius:8px; overflow:hidden; }
  table.main thead th{ text-align:left; padding:12px; background:var(--accent); color:#fff; font-weight:800; font-size:0.95em; }
  table.main tbody td{ padding:12px; border-bottom:1px dashed rgba(0,0,0,0.06); vertical-align:middle; color:var(--text) }
  table.main tr:hover td{ background:linear-gradient(90deg, rgba(0,0,0,0.02), transparent); }
  .badge{ display:inline-block; padding:6px 8px; border-radius:8px; background:linear-gradient(90deg,var(--accent2),#34d399); color:#fff; font-weight:700; }
  .badge.danger{ background:var(--danger); }
  .badge.warning{ background:linear-gradient(90deg,#f59e0b,#fcd34d); }

  .muted{ color:var(--muted); font-size:0.88em; }
  .date-display{ text-align:right; margin-bottom:10px; color:var(--muted); font-weight:700; }

  /* exports */
  .exports{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; align-items:center; }
  .exports button{ padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background:linear-gradient(90deg,var(--accent),#2b6ef6); color:#fff; font-weight:700; }
  .exports .alt{ background:linear-gradient(90deg,#111827,#3f3f46); }
  .exports .mail{ background:linear-gradient(90deg,#f59e0b,#fcd34d); }

  /* stars */
  .stars{ display:inline-flex; gap:6px; align-items:center; }
  .star{ cursor:pointer; color:#ffd66b; font-size:1.05em }
  .star.inactive{ color:#cbd5e1 }

  .stat-list{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:10px; }
  .stat-card{ padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent); border:1px solid var(--border) }

  /* MODAL */
  .modal-overlay{
    position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000;
    display:none; align-items:center; justify-content:center;
  }
  .modal-content{
    background:var(--card); border-radius:12px; padding:24px; max-width:500px; width:90%;
    box-shadow:0 24px 48px rgba(0,0,0,0.3); position:relative;
  }
  .modal-close{ position:absolute; top:10px; right:10px; background:transparent; border:0; font-size:24px; cursor:pointer; color:var(--muted); }
  .modal-header{ margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px; display:flex; align-items:center; }
  .modal-body > div{ margin-bottom:15px; }
  .modal-body label{ display:block; margin-bottom:5px; font-weight:700; color:var(--text); }
  .modal-footer{ margin-top:20px; text-align:right; display:flex; justify-content:space-between; }
  .modal-footer button{ margin-left:8px; }

  @media(max-width:820px){
    .topbar{ flex-direction:column; gap:8px; align-items:stretch }
    .form-row{ flex-direction:column; align-items:stretch }
    table.main{ min-width:600px }
  }
</style>
</head>
<body data-theme="light">

<canvas id="starfield"></canvas>

<header>
  <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;width:100%">
    <div class="title">
      <h1><i class="fa fa-broom" style="color:var(--accent)"></i> Rozpis služeb - Obořiště</h1>
      <div class="sub muted">Plánovač směn kuchyně — moderně a přehledně</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="todayShort" class="muted"></div>
      <button class="btn secondary" onclick="toggleTheme()" id="themeBtn"><i class="fa fa-moon"></i> Přepnout motiv</button>
    </div>
  </div>
</header>

<main class="wrap">

  <div class="topbar">
    <div class="nav card" role="navigation" aria-label="Sekce">
      <button class="active" data-section="schedule" onclick="showSection(event)"><i class="fa fa-calendar-alt"></i> Rozpis</button>
      <button data-section="ratings" onclick="showSection(event)"><i class="fa fa-star"></i> Hodnocení</button>
      <button data-section="stats" onclick="showSection(event)"><i class="fa fa-chart-bar"></i> Statistiky</button>
      <button data-section="settings" onclick="showSection(event)"><i class="fa fa-cogs"></i> Nastavení</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="card" style="display:flex;gap:8px;align-items:center">
        <div class="muted">Filtr - Od</div>
        <input type="date" id="filterFrom" />
        <div class="muted">Do</div>
        <input type="date" id="filterTo" />
        <button class="btn secondary" onclick="applyFilter()"><i class="fa fa-search"></i> Aplikovat</button>
      </div>
    </div>
  </div>

  <section id="section-schedule">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2><i class="fa fa-users"></i> Žáci</h2>
          <div class="muted">Kliknutím na jméno žáka otevřeš jeho profil (poznámka, nemoc, útěk, smazání).</div>
        </div>
        <div class="controls">
          <input type="text" id="newStudent" placeholder="Jméno žáka (např. Jan Novák)"/>
          <button class="btn" onclick="addStudent()"><i class="fa fa-user-plus"></i> Přidat žáka</button>
        </div>
      </div>

      <div class="form-row" style="margin-top:14px">
        <div class="muted">Generovat od:</div>
        <input type="date" id="genFrom" />
        <div class="muted">Počet týdnů:</div>
        <select id="genWeeks">
          <option value="4">4</option>
          <option value="8">8</option>
          <option value="12">12</option>
          <option value="24">24</option>
        </select>
        <button class="btn secondary" onclick="generateNow()"><i class="fa fa-sync-alt"></i> Vygenerovat rozpis</button>
      </div>
    </div>

    <div class="card" id="scheduleCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 class="muted"><i class="fa fa-table"></i> Tabulka rozpisu</h3>
          <div class="muted">Označený řádek odpovídá aktuálnímu týdnu. Nemocní žáci jsou automaticky přeskočeni.</div>
        </div>
        <div class="muted">Počet žáků: <span id="studentCount" class="highlight">0</span></div>
      </div>

      <div class="table-wrap">
        <table class="main" id="mainTable">
          <thead>
            <tr><th>Od</th><th>Do</th><th>Žák</th><th>Hodnocení</th><th>Poznámka</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="exports" style="justify-content:space-between">
        <div style="display:flex;gap:8px">
          <button class="mail" onclick="sendEmail()"><i class="fa fa-envelope"></i> Odeslat emailem</button>
          <button class="alt" onclick="exportPNG(true)"><i class="fa fa-file-image"></i> Export PNG</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted">Řadit podle:</div>
          <select id="sortSelect" onchange="applySort()">
            <option value="date">Datum</option>
            <option value="student_asc">Žák A→Z</option>
            <option value="student_desc">Žák Z→A</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <section id="section-ratings" style="display:none">
    <div class="card">
      <h2><i class="fa fa-star-half-alt"></i> Hodnocení žáků</h2>
      <div class="muted">Klikni na hvězdičky u žáka pro jeho celkové hodnocení (1–5).</div>
      <div style="margin-top:12px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="muted">Řadit podle:</div>
          <select id="ratingSort" onchange="renderRatings()">
            <option value="default">Výchozí pořadí</option>
            <option value="rating_desc">Hodnocení (nejlepší)</option>
            <option value="rating_asc">Hodnocení (nejhorší)</option>
            <option value="count_desc">Počet úklidů (nejvíce)</option>
          </select>
        </div>

        <div id="ratingsList" class="student-list" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <section id="section-stats" style="display:none">
    <div class="card">
      <h2><i class="fa fa-chart-line"></i> Statistiky úklidů</h2>
      <div class="muted">Vyber období a spočítej, kolikrát měl kdo úklid v tomto období.</div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <div class="muted">Od</div><input type="date" id="statFrom" />
        <div class="muted">Do</div><input type="date" id="statTo" />
        <button class="btn secondary" onclick="computeStats()"><i class="fa fa-calculator"></i> Spočítat</button>
      </div>

      <div class="stat-list" id="statCards" style="margin-top:12px"></div>
    </div>
  </section>

  <section id="section-settings" style="display:none">
    <div class="card">
      <h2><i class="fa fa-sun"></i> Nastavení prázdnin</h2>
      <p class="muted">Nastav data prázdnin. V těchto týdnech se do rozpisu automaticky vloží poznámka "PRÁZDNINY" a rotace žáků se přeruší.</p>
      
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div class="muted">Od:</div>
        <input type="date" id="vacationFrom" />
        <div class="muted">Do:</div>
        <input type="date" id="vacationTo" />
        <button class="btn secondary" onclick="saveVacationDates()"><i class="fa fa-save"></i> Uložit prázdniny</button>
        <button class="btn danger" onclick="clearVacationDates()"><i class="fa fa-times"></i> Zrušit prázdniny</button>
        <div id="vacationStatus" class="badge" style="background:transparent; color:var(--muted)"></div>
      </div>
    </div>

    <div class="card">
      <h2><i class="fa fa-database"></i> Správa dat</h2>
      <p class="muted">Data se ukládají do prohlížeče (localStorage). Zde můžeš exportovat všechna data jako JSON nebo vše smazat.</p>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" onclick="exportAllJSON()"><i class="fa fa-download"></i> Exportovat data (JSON)</button>
        <button class="btn secondary" onclick="clearAll()"><i class="fa fa-trash"></i> Vymazat data</button>
      </div>
    </div>
  </section>

</main>

<div id="studentModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()"><i class="fa fa-times"></i></button>
    <div class="modal-header">
      <h3 id="modalStudentName"><i class="fa fa-user-edit"></i> Profil žáka</h3>
      <div id="modalStatusBadge" style="margin-left:15px"></div>
    </div>

    <div class="modal-body">
      <div>
        <label for="modalNote">Poznámka:</label>
        <textarea id="modalNote" style="width:100%; min-height:80px;"></textarea>
      </div>
      
      <h4 style="margin-top:20px; color:var(--accent)">Status (Nemoc / Útěk)</h4>
      <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap">
        <div>
          <label for="modalStatusType">Typ:</label>
          <select id="modalStatusType">
            <option value="">Aktivní</option>
            <option value="nemoc"><i class="fa fa-bed"></i> Nemoc</option>
            <option value="utek"><i class="fa fa-running"></i> Útěk</option>
          </select>
        </div>
        <div>
          <label for="modalDateFrom">Od:</label>
          <input type="date" id="modalDateFrom" />
        </div>
        <div>
          <label for="modalDateTo">Do (volitelné):</label>
          <input type="date" id="modalDateTo" />
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn danger" id="modalDeleteBtn"><i class="fa fa-user-times"></i> Smazat žáka</button>
      <button class="btn" onclick="saveStudentProfile()"><i class="fa fa-save"></i> Uložit</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Storage & data model
   ========================= */
const LS_KEY = 'uklid_oboriste_v4_students';
const LS_RATING = 'uklid_oboriste_ratings_v4';
const LS_VACATION = 'uklid_oboriste_vacation'; // Nový klíč pro prázdniny

let store = {
  students: [], // [{name, note?, status: {type, from, to}}]
  ratings: {},  // name -> rating (1..5)
  vacation: { from: null, to: null } // {from: date_string, to: date_string}
};

function loadStore(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) store.students = JSON.parse(raw);
    const rawR = localStorage.getItem(LS_RATING);
    if(rawR) store.ratings = JSON.parse(rawR);
    // Načtení prázdnin
    const rawV = localStorage.getItem(LS_VACATION);
    if(rawV) store.vacation = JSON.parse(rawV);
    else store.vacation = { from: null, to: null };
  }catch(e){
    console.warn('Load error',e);
  }
}
function saveStore(){
  localStorage.setItem(LS_KEY, JSON.stringify(store.students));
  localStorage.setItem(LS_RATING, JSON.stringify(store.ratings||{}));
  // Uložení prázdnin
  localStorage.setItem(LS_VACATION, JSON.stringify(store.vacation));
}

/* helpers */
function $(id){return document.getElementById(id)}
function formatDate(d){ const dt = new Date(d); return dt.toLocaleDateString('cs-CZ'); }
function todayShort(){ const n = new Date(); $('todayShort').textContent = n.toLocaleDateString('cs-CZ'); }
function isSameDay(d1, d2){ return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }
// Pomocná funkce pro kontrolu, zda týden spadá do prázdnin
function isVacationWeek(weekStart, weekEnd){
    if(!store.vacation.from || !store.vacation.to) return false;
    const vFrom = new Date(store.vacation.from);
    const vTo = new Date(store.vacation.to);
    // Přesné srovnání dat pro týden (7 dní) a prázdniny
    // Týden spadá do prázdnin, pokud se aspoň jeden den týdne překrývá s prázdninami.
    const weekStartMid = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
    const weekEndMid = new Date(weekEnd.getFullYear(), weekEnd.getMonth(), weekEnd.getDate());
    const vFromMid = new Date(vFrom.getFullYear(), vFrom.getMonth(), vFrom.getDate());
    const vToMid = new Date(vTo.getFullYear(), vTo.getMonth(), vTo.getDate());

    // Kontrola překryvu: (StartA <= EndB) AND (EndA >= StartB)
    return (weekStartMid <= vToMid) && (weekEndMid >= vFromMid);
}
function isStatusActive(student, date){
  if(!student.status || !student.status.type || !student.status.from) return false;
  const d = date || new Date();
  const from = new Date(student.status.from);
  // Compare by date only, set time to midnight for accurate comparison
  const d_mid = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const from_mid = new Date(from.getFullYear(), from.getMonth(), from.getDate());

  if(student.status.to){
    const to = new Date(student.status.to);
    const to_mid = new Date(to.getFullYear(), to.getMonth(), to.getDate());
    // Active if date >= from AND date <= to
    return d_mid >= from_mid && d_mid <= to_mid;
  }
  // Active if date >= from (indefinite)
  return d_mid >= from_mid;
}
function getStatusBadge(student){
    if(!student.status || !student.status.type) return {text: '', class: '', icon: ''};
    const active = isStatusActive(student);
    const icon = student.status.type === 'nemoc' ? '<i class="fa fa-bed"></i>' : '<i class="fa fa-running"></i>';
    const text = student.status.type === 'nemoc' ? 'Nemocný' : 'Útěk';
    let dateRange = formatDate(student.status.from);
    if(student.status.to) dateRange += ' - ' + formatDate(student.status.to);
    else dateRange += ' - Neurčeno';

    if(active) return {text: `${icon} ${text} (Aktivní)`, class: student.status.type === 'nemoc' ? 'danger' : 'warning', icon: icon};
    return {text: `${icon} ${text} (${dateRange})`, class: 'muted', icon: icon};
}

/* nav */
function showSection(e){
  const btn = e.currentTarget;
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const sec = btn.getAttribute('data-section');
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  $('section-'+sec).style.display = '';
}

/* students list UI (used in multiple sections) */
function renderStudentsList(){
  // ... (unchanged)
}

/* student profile modal */
// ... (unchanged)

/* ratings */
// ... (unchanged)

/* assignments generation */
function generateAssignmentsFor(startDate, weeks){
  const out = [];
  const sArr = store.students;
  if(sArr.length === 0) return out;
  const start = new Date(startDate);
  let base = new Date(start.getFullYear(), start.getMonth(), start.getDate());

  // Najít index žáka, který má službu v týdnu před startDate
  // (pro zjištění, odkud navázat rotaci)
  // ... (Složitá logika pro obnovení rotace by byla zde, pro jednoduchost začneme od 0)
  let studentIndex = 0; 
  
  // Přeskočíme žáky, kteří jsou nemocní/nepřítomní V OKAMŽIK GENERACE
  // Toto je jen pro nastavení počátečního indexu
  let attempts = 0;
  while(isStatusActive(sArr[studentIndex % sArr.length], base) && attempts < sArr.length){
      studentIndex++;
      attempts++;
  }
  
  if (attempts >= sArr.length) {
      // Všichni jsou nemocní/nepřítomní, začínáme od prvního.
      studentIndex = 0;
  }
  
  // Skutečný index pro rotaci (který se bude inkrementovat)
  let currentRotationIndex = studentIndex; 
  
  for(let w=0; w<weeks; w++){
    const sd = new Date(base.getFullYear(), base.getMonth(), base.getDate() + w*7);
    const ed = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate() + 6);
    
    // **NOVÁ LOGIKA PRÁZDNIN**
    if(isVacationWeek(sd, ed)){
        // Pokud je týden prázdninový, vložíme záznam "PRÁZDNINY" a nepřeskočíme index
        out.push({start: sd, end: ed, student: 'PRÁZDNINY', note: 'Školní prázdniny', type: 'VACATION'});
        continue; // Pokračujeme na další týden bez rotace žáka
    }
    
    // Standardní logika rotace a přeskočení nemocných/nepřítomných
    let studentObj = sArr[currentRotationIndex % sArr.length];
    attempts = 0;
    
    // Hledáme žáka, který NENÍ nemocný/nepřítomný v tomto konkrétním týdnu
    while(isStatusActive(studentObj, sd) && attempts < sArr.length){
      currentRotationIndex++;
      studentObj = sArr[currentRotationIndex % sArr.length];
      attempts++;
    }
    
    if(attempts >= sArr.length) {
        // Všichni dostupní žáci jsou nemocní/nepřítomní i v tomto týdnu
        studentObj = sArr[currentRotationIndex % sArr.length]; // Zadáme prvního nemocného (měl by se zvýraznit v tabulce)
    } else {
        // Byl nalezen volný žák, index se posune na dalšího
        currentRotationIndex++;
    }

    out.push({start: sd, end: ed, student: studentObj.name, note: '', type: 'ASSIGNMENT'});
  }
  return out;
}

/* render table */
let currentAssignments = [];
function renderAssignmentsTable(assigns){
  currentAssignments = assigns;
  const tbody = $('tableBody');
  tbody.innerHTML = '';
  const now = new Date();

  assigns.forEach((row, idx)=>{
    const tr = document.createElement('tr');
    
    const isCurrentWeek = now >= row.start && now <= row.end;
    if(isCurrentWeek){ tr.style.background = 'rgba(25, 99, 235, 0.1)'; }

    const td1 = document.createElement('td'); td1.textContent = formatDate(row.start);
    const td2 = document.createElement('td'); td2.textContent = formatDate(row.end);
    
    const td3 = document.createElement('td'); 
    const td4_rating = document.createElement('td');
    const td5 = document.createElement('td');
    
    if(row.type === 'VACATION'){
        // **Zobrazení prázdnin**
        td3.innerHTML = `<span class="badge warning"><i class="fa fa-sun"></i> ${row.student}</span>`;
        td4_rating.textContent = '-';
        td5.textContent = row.note;
        tr.style.background = 'rgba(255, 204, 0, 0.1)'; // Žluté podbarvení pro prázdniny
    } else {
        // **Zobrazení běžné služby**
        td3.textContent = row.student;

        if(isCurrentWeek){
            // Zobrazení hvězdiček pro hodnocení aktuálního žáka
            const stars = document.createElement('div'); stars.className='stars';
            const r = store.ratings[row.student] || 0;
            for(let k=1;k<=5;k++){
                const i = document.createElement('i'); i.className = 'star fa fa-star ' + (k<=r ? '' : 'inactive');
                i.dataset.index = k;
                i.onclick = (e)=>{ e.stopPropagation(); setRating(row.student, k); }; 
                stars.appendChild(i);
            }
            td4_rating.appendChild(stars);
        } else {
            td4_rating.textContent = (store.ratings[row.student] || 0) + ' / 5';
        }

        const noteIn = document.createElement('input'); noteIn.type='text'; noteIn.placeholder='Poznámka...';
        noteIn.style.padding='6px'; noteIn.style.borderRadius='6px'; noteIn.style.border='1px solid var(--border)';
        noteIn.value = row.note || '';
        noteIn.onchange = (e)=>{ row.note = e.target.value; };
        td5.appendChild(noteIn);
    }

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4_rating); tr.appendChild(td5);
    tbody.appendChild(tr);
  });
}

/* exports */
async function exportPNG(clean=false){
  // ... (unchanged)
}

// Point 4: Send email
function sendEmail(){
    let body = 'Dobrý den,\n\nzasílám rozpis služeb:\n\n';
    body += '==================================================\n';
    body += 'Rozpis služeb - Obořiště\n';
    body += '==================================================\n';
    
    currentAssignments.forEach(r => {
        const start = formatDate(r.start);
        const end = formatDate(r.end);
        let studentText = r.student;
        if(r.type === 'VACATION') studentText = 'PRÁZDNINY';
        
        const note = r.note ? ` (Pozn.: ${r.note})` : '';
        body += `Týden: ${start} - ${end}\n`;
        body += `Žák/Status: ${studentText}${note}\n`;
        body += '--------------------------------------------------\n';
    });

    const mailtoLink = `mailto:?subject=${encodeURIComponent('Rozpis služeb - Obořiště')}&body=${encodeURIComponent(body)}`;
    window.open(mailtoLink, '_self');
}

/* sorting */
// ... (unchanged)

/* stats */
// ... (unchanged)

/* filters generate */
// ... (unchanged)

/* generate now */
function generateNow(){
  const from = $('genFrom').value ? new Date($('genFrom').value) : new Date();
  let weeks = parseInt($('genWeeks').value,10) || 4;
  // if more students than weeks, extend weeks so every student gets at least one turn
  weeks = Math.max(weeks, store.students.length);
  const assigns = generateAssignmentsFor(from, weeks);
  renderAssignmentsTable(assigns);
}

/* utilities */
// ... (unchanged)

/* settings - VACATION */
function updateVacationUI(){
    const vFrom = store.vacation.from;
    const vTo = store.vacation.to;
    
    if(vFrom && vTo){
        $('vacationFrom').value = new Date(vFrom).toISOString().slice(0,10);
        $('vacationTo').value = new Date(vTo).toISOString().slice(0,10);
        $('vacationStatus').className = 'badge accent';
        $('vacationStatus').innerHTML = `<i class="fa fa-plane"></i> Aktivní: ${formatDate(vFrom)} – ${formatDate(vTo)}`;
    } else {
        $('vacationFrom').value = '';
        $('vacationTo').value = '';
        $('vacationStatus').className = 'badge muted';
        $('vacationStatus').textContent = 'Prázdniny nenastaveny';
    }
}
function saveVacationDates(){
    const from = $('vacationFrom').value;
    const to = $('vacationTo').value;

    if(!from || !to){
        alert('Musíš vybrat datum OD i datum DO.');
        return;
    }
    if(new Date(from) >= new Date(to)){
        alert('Datum "Od" musí být dříve než datum "Do".');
        return;
    }

    store.vacation = { from, to };
    saveStore();
    updateVacationUI();
    generateNow(); // Přegeneruje rozpis s novými prázdninami
}
function clearVacationDates(){
    store.vacation = { from: null, to: null };
    saveStore();
    updateVacationUI();
    generateNow(); // Přegeneruje rozpis
}

/* settings - DATA */
function clearAll(){
  if(!confirm('Opravdu vymazat všechna data?')) return;
  localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_RATING); localStorage.removeItem(LS_VACATION);
  store = {students:[], ratings:{}, vacation: { from: null, to: null }};
  redrawAll();
}
function exportAllJSON(){
  const dataToExport = {
      students: store.students,
      ratings: store.ratings,
      vacation: store.vacation,
  };
  const blob = new Blob([JSON.stringify(dataToExport,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'uklid_data.json'; a.click();
}

/* redraw / orchestrace */
function redrawAll(){
  loadStore();
  todayShort();
  if(!store.students) store.students = [];
  if(!store.ratings) store.ratings = {};
  renderStudentsList();
  updateVacationUI(); // Aktualizace UI prázdnin
  
  // set defaults for date inputs if empty
  const now = new Date();
  if(!$('genFrom').value) $('genFrom').value = now.toISOString().slice(0,10);
  const tom = new Date(now.getFullYear(), now.getMonth(), now.getDate()+28);
  if(!$('filterFrom').value) $('filterFrom').value = now.toISOString().slice(0,10);
  if(!$('filterTo').value) $('filterTo').value = tom.toISOString().slice(0,10);
  if(!$('statFrom').value) $('statFrom').value = now.toISOString().slice(0,10);
  if(!$('statTo').value) $('statTo').value = tom.toISOString().slice(0,10);

  // initial assignments
  const weeks = Math.max(4, store.students.length);
  const assigns = generateAssignmentsFor(new Date(), weeks);
  renderAssignmentsTable(assigns);
  renderRatings();
}

/* add student */
function addStudent(){
  const val = $('newStudent').value.trim();
  if(!val) return alert('Zadej jméno žáka.');
  // prevent duplicates
  if((store.students||[]).some(s=>s.name.toLowerCase()===val.toLowerCase())){ alert('Tento žák je již v seznamu.'); return; }
  store.students.push({name: val, note: '', status: {}});
  saveStore();
  $('newStudent').value='';
  redrawAll();
}


/* theme & starfield animation */
// ... (unchanged)

/* init */
(function init(){
  loadStore();
  if(!store.students) store.students = [];
  if(!store.ratings) store.ratings = {};
  if(!store.vacation) store.vacation = { from: null, to: null };
  todayShort();
  redrawAll();
  // if dark theme on load, start stars
  if(document.body.getAttribute('data-theme') === 'dark') startStarfield();
})();

</script>

</body>
</html>
