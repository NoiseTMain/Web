<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Rozpis služeb - Obořiště</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #2563eb;
    --accent2: #10b981;
    --glass: rgba(255,255,255,0.6);
    --border: rgba(0,0,0,0.06);
    --text: #0f1724;
    --danger: #ef4444;
  }
  [data-theme='dark']{
    --bg: #05060a;
    --card: rgba(35,45,60,0.5); /* Zvýšená průhlednost pro Liquid Glass */
    --muted: #bfc8d2;
    --accent: #5e79ff; /* Světlejší accent v dark modu */
    --accent2: #047857;
    --glass: rgba(255,255,255,0.08); /* Mírně silnější odlesk */
    --border: rgba(255,255,255,0.1);
    --text: #fdf6e3; 
    --danger: #dc2626;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{
    height:100%;
    overflow-x: hidden; 
  }
  body{
    font-family:Inter, "Segoe UI", Tahoma, sans-serif;
    background: linear-gradient(180deg,var(--bg), #eef2ff);
    color: var(--text);
    padding-bottom:40px;
    transition:all .25s;
    position:relative;
    overflow-x:hidden;
    touch-action: pan-y;
  }
  /* GALAKTICKÉ POZADÍ (DARK MODE) */
  [data-theme='dark'] body{ 
    /* Gradient, který dává pocit hloubky "galaxie" */
    background: radial-gradient(circle at 10% 10%, #071028 0%, #04050a 60%); 
  }

  /* Starfield (plátno pro hvězdy) */
  #starfield {
    position: fixed;
    left: 0; top: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0;
    opacity: 0;
    transition: opacity 0.4s ease;
  }
  [data-theme='dark'] #starfield { opacity: 1; }

  /* header s mramorovým okrajem */
  header{
    position: sticky; /* Zajištění, že hlavička zůstane viditelná */
    top: 0;
    z-index: 10; /* VYŠŠÍ Z-INDEX, aby byla nad obsahem */
    background: var(--card); /* Použijeme barvu karty s blur efektem */
    padding:20px 18px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid var(--border);
    /* LIQUID GLASS EFEKT (PRO VŠECHNY PRVKY S POZADÍM) */
    backdrop-filter: blur(12px); 
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); /* Jemný stín */
    color: var(--text);
  }
  [data-theme='dark'] header{
    border-image: none;
    border-bottom: 1px solid var(--border);
  }
  .title{ display:flex; flex-direction:column; z-index:5; }
  .title h1{ font-size:20px; margin-bottom:4px; }
  .title .sub{ font-size:12px; color:var(--muted) }

  .wrap{
    max-width:1100px;
    margin:16px auto;
    padding:0 18px; 
    position:relative; 
    z-index:5;
    transition: background 0.25s;
  }
  [data-theme='dark'] .wrap{
      /* Provedl jsem odstranění pozadí pro wrap, aby byl vidět blur u jednotlivých karet */
      background: transparent;
      border-radius: 0; 
      padding-top: 0;
      padding-bottom: 0;
  }

  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .controls{display:flex;gap:8px;align-items:center}

  /* LIQUID GLASS STYLY PRO KARTY */
  .card{
    background:var(--card);
    border-radius:24px; /* Větší zaoblení pro iOS pocit */
    padding:18px;
    box-shadow: 0 10px 40px rgba(15,23,42,0.15); /* Výraznější stín */
    border:1px solid var(--border);
    transition:transform .2s ease, box-shadow .2s ease, background .25s, border-radius .2s;
    backdrop-filter: blur(12px); /* KLÍČOVÝ LIQUID GLASS EFEKT */
    -webkit-backdrop-filter: blur(12px);
  }
  .card + .card{ margin-top:14px }
  .card:hover{ transform: translateY(-4px); box-shadow:0 18px 40px rgba(2,6,23,0.15) }
  
  /* nav - také jako Liquid Glass */
  .nav{ 
    display:flex; gap:8px; background:var(--card); 
    padding:8px; border-radius:18px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
  .nav button{ 
    background:transparent; border:1px solid transparent; 
    padding:8px 12px; border-radius:14px; 
    cursor:pointer; color:var(--muted); font-weight:700; 
    transition: all 0.2s ease;
  }
  .nav button.active{ 
    background:linear-gradient(90deg,var(--accent),#2b6ef6); color:#fff; 
    border-color:transparent; 
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
  }

  /* forms - Průhlednější pro Liquid Glass */
  input[type=text], input[type=date], select, textarea{
    padding:10px 12px; border-radius:10px; border:1px solid var(--border); min-width:150px; background:var(--glass); color:var(--text);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  
  /* student list - také jako Liquid Glass */
  .student-item{ 
    display:flex; align-items:center; gap:10px; padding:12px; 
    border-radius:16px; border:1px solid var(--border); 
    background:var(--card); 
    cursor:pointer; 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .student-item:hover{ background:linear-gradient(180deg, var(--glass), transparent); }
  [data-theme='dark'] .student-item:hover{ background:linear-gradient(180deg, rgba(255,255,255,0.1), transparent); }
  
  /* NOVÉ: Seznam prázdnin (jako řádky/karty) - také Liquid Glass */
  .vacation-item{
    display:flex; justify-content:space-between; align-items:center; gap:15px; padding:14px; 
    border-radius:16px; border:1px solid var(--border); background:var(--card); 
    cursor:pointer; transition:background .18s;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  
  /* table - pro větší skleněný pocit */
  table.main, table.settings{ 
    width:100%; border-collapse:collapse; min-width:720px; 
    background:var(--card); 
    border-radius:16px; 
    overflow:hidden; 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  
  /* MODAL - také Liquid Glass */
  .modal-overlay{
    position:fixed; left:0; top:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.4); /* Mírně světlejší overlay */
    z-index:1000;
    display:none; align-items:center; justify-content:center;
  }
  .modal-content{
    background:var(--card); 
    border-radius:24px; /* Větší zaoblení */
    padding:30px; /* Větší padding */
    max-width:500px; width:90%;
    box-shadow:0 24px 48px rgba(0,0,0,0.5); 
    position:relative;
    backdrop-filter: blur(20px); /* Silný blur pro Modal */
    -webkit-backdrop-filter: blur(20px);
  }
  
  /* Dodatečné styly pro zvýraznění textu v tmavém režimu s blur pozadím */
  [data-theme='dark'] table.main tr:hover td, [data-theme='dark'] table.settings tr:hover td{ 
    background:rgba(255,255,255,0.06); /* Mírně silnější hover efekt */
  }

  @media(max-width:820px){
    .topbar{ flex-direction:column; gap:8px; align-items:stretch }
    .form-row{ flex-direction:column; align-items:stretch }
    table.main, table.settings{ min-width:600px }
  }
</style>
</head>
<body data-theme="dark">

<canvas id="starfield"></canvas>

<header>
  <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;width:100%">
    <div class="title">
      <h1><i class="fa fa-broom" style="color:var(--accent)"></i> Rozpis služeb - Obořiště</h1>
      <div class="sub muted">Aplikace vytvorena od A.Horvath</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="todayShort" class="muted"></div>
      <button class="btn secondary" onclick="toggleTheme()" id="themeBtn"><i class="fa fa-sun"></i> Přepnout motiv</button>
    </div>
  </div>
</header>

<main class="wrap">

  <div class="topbar">
    <div class="nav card" role="navigation" aria-label="Sekce">
      <button class="active" data-section="schedule" onclick="showSection(event)"><i class="fa fa-calendar-alt"></i> Rozpis</button>
      <button data-section="ratings" onclick="showSection(event)"><i class="fa fa-star"></i> Hodnocení</button>
      <button data-section="stats" onclick="showSection(event)"><i class="fa fa-chart-bar"></i> Statistiky</button>
      <button data-section="settings" onclick="showSection(event)"><i class="fa fa-cogs"></i> Nastavení</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="card" style="display:flex;gap:8px;align-items:center">
        <div class="muted">Filtr - Od</div>
        <input type="date" id="filterFrom" />
        <div class="muted">Do</div>
        <input type="date" id="filterTo" />
        <button class="btn secondary" onclick="applyFilter()"><i class="fa fa-search"></i> Aplikovat</button>
      </div>
    </div>
  </div>

  <section id="section-schedule">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2><i class="fa fa-users"></i> Žáci</h2>
          <div class="muted">  </div>
        </div>
        <div class="controls">
          <input type="text" id="newStudent" placeholder="Jméno žáka"/>
          <button class="btn" onclick="addStudent()"><i class="fa fa-user-plus"></i> Přidat žáka</button>
        </div>
      </div>

      <div class="form-row" style="margin-top:14px">
        <div class="muted">Generovat od:</div>
        <input type="date" id="genFrom" />
        <div class="muted">Počet týdnů:</div>
        <select id="genWeeks">
          <option value="4">4</option>
          <option value="8">8</option>
          <option value="12">12</option>
          <option value="24">24</option>
        </select>
        <button class="btn secondary" onclick="generateNow()"><i class="fa fa-sync-alt"></i> Vygenerovat rozpis</button>
      </div>
    </div>

    <div class="card" id="scheduleCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 class="muted"><i class="fa fa-table"></i> Tabulka rozpisu</h3>
          <div class="muted">Označený řádek odpovídá aktuálnímu týdnu. Nemocní / Útěkoví žáci jsou automaticky přeskočeni.</div>
        </div>
        <div class="muted">Počet žáků: <span id="studentCount" class="highlight">0</span></div>
      </div>

      <div class="table-wrap">
        <table class="main" id="mainTable">
          <thead>
            <tr><th>Od</th><th>Do</th><th>Žák</th><th>Hodnocení</th><th>Poznámka</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="exports" style="justify-content:space-between">
        <div style="display:flex;gap:8px">
          <button class="mail" onclick="sendEmail()"><i class="fa fa-envelope"></i> Odeslat emailem</button>
          <button class="alt" onclick="exportPNG(true)"><i class="fa fa-file-image"></i> Export PNG</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted">Řadit podle:</div>
          <select id="sortSelect" onchange="applySort()">
            <option value="date">Datum</option>
            <option value="student_asc">Žák A→Z</option>
            <option value="student_desc">Žák Z→A</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <section id="section-ratings" style="display:none">
    <div class="card">
      <h2><i class="fa fa-star-half-alt"></i> Hodnocení žáků a Profily žáků</h2>
      <div class="muted">Klikni na hvězdičky u žáka pro jeho celkové hodnocení (1–5).</div>
      <div style="margin-top:12px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="muted">Řadit podle:</div>
          <select id="ratingSort" onchange="renderRatings()">
            <option value="default">Výchozí pořadí</option>
            <option value="rating_desc">Hodnocení (nejlepší)</option>
            <option value="rating_asc">Hodnocení (nejhorší)</option>
            <option value="count_desc">Počet úklidů (nejvíce)</option>
          </select>
        </div>

        <div id="ratingsList" class="student-list" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <section id="section-stats" style="display:none">
    <div class="card">
      <h2><i class="fa fa-chart-line"></i> Statistiky úklidů</h2>
      <div class="muted">Vyber období a spočítej, kolikrát měl kdo úklid v tomto období.</div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <div class="muted">Od</div><input type="date" id="statFrom" />
        <div class="muted">Do</div><input type="date" id="statTo" />
        <button class="btn secondary" onclick="computeStats()"><i class="fa fa-calculator"></i> Spočítat</button>
      </div>

      <div class="stat-list" id="statCards" style="margin-top:12px"></div>
    </div>
  </section>

  <section id="section-settings" style="display:none">
    <div class="card">
      <h2><i class="fas fa-border-style"></i> Nastavení prázdnin a ředitelského volna</h2>
      <p class="muted">Nastav data prázdnin nebo ředitelského volna. Kliknutím na období otevřeš jeho "profil" pro úpravu.</p>
      
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border:1px solid var(--border);padding:10px;border-radius:12px;background:var(--glass); backdrop-filter: blur(8px)">
        <div class="muted">Typ:</div>
        <select id="vacationType">
          <option value="holiday">Školní prázdniny</option>
          <option value="director">Ředitelské volno</option>
        </select>
        <div class="muted">Od:</div>
        <input type="date" id="vacationFrom" style="flex-grow:1"/>
        <div class="muted">Do:</div>
        <input type="date" id="vacationTo" style="flex-grow:1"/>
        <button class="btn" onclick="addVacationPeriod()"><i class="fa fa-plus"></i> Přidat období</button>
      </div>

      <div id="vacationList">
        </div>

    </div>

    <div class="card">
      <h2><i class="fa fa-database"></i> Správa dat</h2>
      <p class="muted">Data se ukládají do prohlížeče (localStorage). Zde můžeš exportovat všechna data jako JSON, nahrát je zpět, nebo vše smazat.</p>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="exportAllJSON()"><i class="fa fa-download"></i> Exportovat data (JSON)</button>
        
        <input type="file" id="importJsonFile" accept=".json" style="display:none;" onchange="importAllJSON(event)">
        <button class="btn secondary" onclick="document.getElementById('importJsonFile').click()"><i class="fa fa-upload"></i> Nahrát JSON data</button>
        <button class="btn danger" onclick="clearAll()"><i class="fa fa-trash"></i> Vymazat data</button>
      </div>
    </div>
  </section>

</main>

<div id="studentModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('studentModal')"><i class="fa fa-times"></i></button>
    <div class="modal-header">
      <h3 id="modalStudentName"><i class="fa fa-user-edit"></i> Profil žáka</h3>
      <div id="modalStatusBadge" style="margin-left:15px"></div>
    </div>

    <div class="modal-body">
      <div>
        <label for="modalNote">Poznámka:</label>
        <textarea id="modalNote" style="width:100%; min-height:80px;"></textarea>
      </div>
      
      <h4 style="margin-top:20px; color:var(--accent)">Status (Nemoc / Útěk)</h4>
      <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap">
        <div>
          <label for="modalStatusType">Typ:</label>
          <select id="modalStatusType">
            <option value="">Aktivní</option>
            <option value="nemoc"><i class="fa fa-bed"></i> Nemoc</option>
            <option value="utek"><i class="fa fa-running"></i> Útěk</option>
          </select>
        </div>
        <div>
          <label for="modalDateFrom">Od:</label>
          <input type="date" id="modalDateFrom" />
        </div>
        <div>
          <label for="modalDateTo">Do (volitelné):</label>
          <input type="date" id="modalDateTo" />
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn danger" id="modalDeleteBtn"><i class="fa fa-user-times"></i> Smazat žáka</button>
      <button class="btn" onclick="saveStudentProfile()"><i class="fa fa-save"></i> Uložit</button>
    </div>
  </div>
</div>

<div id="vacationModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('vacationModal')"><i class="fa fa-times"></i></button>
      <div class="modal-header">
        <h3 id="modalVacationTitle"><i class="fa fa-calendar-check"></i> Úprava období</h3>
        <div id="modalVacationTypeBadge" style="margin-left:15px"></div>
      </div>
  
      <div class="modal-body">
        <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap">
            <div>
                <label for="modalVacationFrom">Od:</label>
                <input type="date" id="modalVacationFrom" />
            </div>
            <div>
                <label for="modalVacationTo">Do:</label>
                <input type="date" id="modalVacationTo" />
            </div>
            <div style="display:none">
                <input type="hidden" id="modalVacationType" value=""> 
            </div>
        </div>

        <div>
            <label for="modalVacationNote">Poznámka (Zobrazí se v rozpisu):</label>
            <textarea id="modalVacationNote" style="width:100%; min-height:80px;" placeholder="Např. 'Velikonoční prázdniny' nebo 'Volno z důvodu školení'"></textarea>
        </div>
      </div>
  
      <div class="modal-footer">
        <button class="btn danger" id="modalVacationDeleteBtn"><i class="fa fa-trash"></i> Smazat období</button>
        <button class="btn" onclick="saveVacationProfile()"><i class="fa fa-save"></i> Uložit změny</button>
      </div>
    </div>
  </div>


<script>
/* =========================
   Storage & data model
   ========================= */
const LS_KEY = 'uklid_oboriste_v4_students';
const LS_RATING = 'uklid_oboriste_ratings_v4';
const LS_VACATION = 'uklid_oboriste_vacation_periods'; 

let store = {
  students: [], 
  ratings: {},  
  vacationPeriods: [], 
};

function loadStore(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) store.students = JSON.parse(raw);
    const rawR = localStorage.getItem(LS_RATING);
    if(rawR) store.ratings = JSON.parse(rawR);
    const rawV = localStorage.getItem(LS_VACATION);
    if(rawV) store.vacationPeriods = JSON.parse(rawV);
    else store.vacationPeriods = [];
  }catch(e){
    console.warn('Load error',e);
  }
}
function saveStore(){
  localStorage.setItem(LS_KEY, JSON.stringify(store.students));
  localStorage.setItem(LS_RATING, JSON.stringify(store.ratings||{}));
  localStorage.setItem(LS_VACATION, JSON.stringify(store.vacationPeriods));
}

/* helpers */
function $(id){return document.getElementById(id)}
function formatDate(d){ 
    if(!d) return '';
    const dt = new Date(d); 
    if(isNaN(dt.getTime())) { 
        const parts = d.split('-');
        if(parts.length === 3) {
            const validDate = new Date(parts[0], parts[1]-1, parts[2]); 
            if(!isNaN(validDate.getTime())) return validDate.toLocaleDateString('cs-CZ');
        }
        return d; 
    }
    return dt.toLocaleDateString('cs-CZ'); 
}
function todayShort(){ const n = new Date(); $('todayShort').textContent = n.toLocaleDateString('cs-CZ'); }
function isSameDay(d1, d2){ return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }

// Pomocná funkce pro kontrolu, zda týden spadá do PRÁZDNINOVÉHO období
function getVacationOverlap(weekStart, weekEnd){
    for(const period of store.vacationPeriods){
        if(!period.from || !period.to) continue;
        const vFrom = new Date(period.from);
        const vTo = new Date(period.to);
        
        const weekStartMid = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
        const weekEndMid = new Date(weekEnd.getFullYear(), weekEnd.getMonth(), weekEnd.getDate());
        const vFromMid = new Date(vFrom.getFullYear(), vFrom.getMonth(), vFrom.getDate());
        const vToMid = new Date(vTo.getFullYear(), vTo.getMonth(), vTo.getDate());

        if((weekStartMid <= vToMid) && (weekEndMid >= vFromMid)){
            return period; 
        }
    }
    return null;
}

function isStatusActive(student, date){
  if(!student.status || !student.status.type || !student.status.from) return false;
  const d = date || new Date();
  const from = new Date(student.status.from);
  const d_mid = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const from_mid = new Date(from.getFullYear(), from.getMonth(), from.getDate());

  if(student.status.to){
    const to = new Date(student.status.to);
    const to_mid = new Date(to.getFullYear(), to.getMonth(), to.getDate());
    return d_mid >= from_mid && d_mid <= to_mid;
  }
  return d_mid >= from_mid;
}
function getStatusBadge(student){
    if(!student.status || !student.status.type) return {text: '', class: '', icon: ''};
    const active = isStatusActive(student);
    const icon = student.status.type === 'nemoc' ? '<i class="fa fa-bed"></i>' : '<i class="fa fa-running"></i>';
    const text = student.status.type === 'nemoc' ? 'Nemocný' : 'Útěk';
    let dateRange = formatDate(student.status.from);
    if(student.status.to) dateRange += ' - ' + formatDate(student.status.to);
    else dateRange += ' - Neurčeno';

    if(active) return {text: `${icon} ${text} (Aktivní)`, class: student.status.type === 'nemoc' ? 'danger' : 'warning', icon: icon};
    return {text: `${icon} ${text} (${dateRange})`, class: 'muted', icon: icon};
}

/* nav */
function showSection(e){
  const btn = e.currentTarget;
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const sec = btn.getAttribute('data-section');
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  $('section-'+sec).style.display = '';
}

/* students list UI (used in multiple sections) */
function renderStudentsList(){
  const listContainer = document.createElement('div');
  listContainer.className = 'student-list';
  (store.students||[]).forEach((sObj, idx)=>{
    const item = document.createElement('div'); item.className = 'student-item';
    item.onclick = ()=>openStudentModal(sObj.name);

    const avatar = document.createElement('div'); avatar.style.width='44px'; avatar.style.height='44px'; avatar.style.borderRadius='8px';
    avatar.style.display='flex'; avatar.style.alignItems='center'; avatar.style.justifyContent='center';
    const color = pickColor(sObj.name);
    avatar.style.background = `linear-gradient(135deg, ${color}, ${shadeColor(color, -12)})`;
    avatar.style.color='#fff'; avatar.style.fontWeight='700';
    avatar.textContent = sObj.name.split(' ').map(p=>p[0]).slice(0,2).join('');
    item.appendChild(avatar);

    const info = document.createElement('div'); info.style.marginLeft='8px';
    const nm = document.createElement('div'); nm.className='name'; nm.textContent = sObj.name;
    info.appendChild(nm);

    const statusInfo = getStatusBadge(sObj);
    if(statusInfo.text){
        const badge = document.createElement('span'); badge.className = 'badge ' + statusInfo.class;
        badge.innerHTML = statusInfo.text;
        info.appendChild(badge);
    }
    
    item.appendChild(info);

    const meta = document.createElement('div'); meta.className='meta';
    const stars = document.createElement('div'); stars.className='stars';
    const r = store.ratings[sObj.name] || 0;
    for(let k=1;k<=5;k++){
      const i = document.createElement('i'); i.className = 'star fa fa-star ' + (k<=r ? '' : 'inactive');
      i.dataset.index = k;
      i.onclick = (e)=>{ e.stopPropagation(); setRating(sObj.name, k); };
      stars.appendChild(i);
    }
    meta.appendChild(stars);
    item.appendChild(meta);
    listContainer.appendChild(item);
  });

  const schedFirstCard = document.querySelector('#section-schedule .card');
  let existingList = schedFirstCard.querySelector('.student-list');
  if(existingList) existingList.replaceWith(listContainer.cloneNode(true));
  else schedFirstCard.appendChild(listContainer.cloneNode(true));

  $('ratingsList').innerHTML = '';
  $('ratingsList').appendChild(listContainer.cloneNode(true));

  $('studentCount').textContent = store.students.length;
}

/* student profile modal (omitted for brevity, assume unchanged logic) */
let currentStudent = null;
function openStudentModal(name){
    currentStudent = store.students.find(s => s.name === name);
    if(!currentStudent) return;

    $('modalStudentName').innerHTML = `<i class="fa fa-user-edit"></i> Profil žáka: ${currentStudent.name}`;
    $('modalNote').value = currentStudent.note || '';
    
    const status = currentStudent.status || {};
    $('modalStatusType').value = status.type || '';
    $('modalDateFrom').value = status.from ? new Date(status.from).toISOString().slice(0,10) : '';
    $('modalDateTo').value = status.to ? new Date(status.to).toISOString().slice(0,10) : '';

    const badge = getStatusBadge(currentStudent);
    if(badge.text) $('modalStatusBadge').innerHTML = `<span class="badge ${badge.class}">${badge.text}</span>`;
    else $('modalStatusBadge').innerHTML = '';

    $('modalDeleteBtn').onclick = () => deleteStudent(currentStudent.name);

    $('studentModal').style.display = 'flex';
}
function closeModal(id = 'studentModal'){
    $(id).style.display = 'none';
    if(id === 'studentModal') currentStudent = null;
    if(id === 'vacationModal') currentVacation = null;
}
function saveStudentProfile(){
    if(!currentStudent) return;
    
    currentStudent.note = $('modalNote').value.trim();

    const type = $('modalStatusType').value;
    const from = $('modalDateFrom').value;
    const to = $('modalDateTo').value;

    if(type && from){
        currentStudent.status = {type, from, to};
    } else {
        currentStudent.status = {}; 
    }

    saveStore();
    closeModal('studentModal');
    redrawAll();
}
function deleteStudent(name){
    if(!confirm(`Opravdu smazat žáka ${name}? Tuto akci nelze vrátit.`)) return;
    store.students = store.students.filter(s => s.name !== name);
    delete store.ratings[name];
    saveStore();
    closeModal('studentModal');
    redrawAll();
}
/* ratings */
function setRating(name, value){
    store.ratings[name] = value;
    saveStore();
    renderStudentsList(); 
    renderAssignmentsTable(currentAssignments); 
}
function renderRatings(){
  const sort = $('ratingSort') ? $('ratingSort').value : 'default';
  let arr = [...store.students];
  if(sort === 'rating_desc') arr.sort((a,b)=>(store.ratings[b.name]||0)-(store.ratings[a.name]||0));
  if(sort === 'rating_asc') arr.sort((a,b)=>(store.ratings[a.name]||0)-(store.ratings[b.name]||0));
  if(sort === 'count_desc') {
    const counts = {};
    const weeks = 52;
    const assigns = generateAssignmentsFor(new Date(), weeks, true); 
    assigns.forEach(a=> counts[a.student] = (counts[a.student]||0)+1);
    arr.sort((a,b)=>(counts[b.name]||0)-(counts[a.name]||0));
  }
  
  const container = $('ratingsList'); container.innerHTML = '';
  arr.forEach(sObj=>{
    const item = document.createElement('div'); item.className = 'student-item';
    item.onclick = ()=>openStudentModal(sObj.name);

    const avatar = document.createElement('div'); avatar.style.width='44px'; avatar.style.height='44px'; avatar.style.borderRadius='8px';
    avatar.style.display='flex'; avatar.style.alignItems='center'; avatar.style.justifyContent='center';
    const color = pickColor(sObj.name);
    avatar.style.background = `linear-gradient(135deg, ${color}, ${shadeColor(color, -12)})`;
    avatar.style.color='#fff'; avatar.style.fontWeight='700';
    avatar.textContent = sObj.name.split(' ').map(p=>p[0]).slice(0,2).join('');
    item.appendChild(avatar);

    const info = document.createElement('div'); info.style.marginLeft='8px';
    const nm = document.createElement('div'); nm.className='name'; nm.textContent = sObj.name;
    info.appendChild(nm);
    item.appendChild(info);

    const meta = document.createElement('div'); meta.className='meta';
    const rating = store.ratings[sObj.name] || 0;
    const stars = document.createElement('div'); stars.className='stars';
    for(let k=1;k<=5;k++){
      const i = document.createElement('i'); i.className = 'star fa fa-star ' + (k<=rating ? '' : 'inactive');
      i.onclick = (e)=>{ e.stopPropagation(); setRating(sObj.name, k); renderRatings(); };
      stars.appendChild(i);
    }
    meta.appendChild(stars);
    item.appendChild(meta);
    container.appendChild(item);
  });
}


/* assignments generation (omitted for brevity, assume unchanged logic) */
function generateAssignmentsFor(startDate, weeks){
  const out = [];
  const sArr = store.students;
  if(sArr.length === 0) return out;
  const start = new Date(startDate);
  let base = new Date(start.getFullYear(), start.getMonth(), start.getDate());

  let studentIndex = 0; 
  
  let attempts = 0;
  while(isStatusActive(sArr[studentIndex % sArr.length], base) && attempts < sArr.length){
      studentIndex++;
      attempts++;
  }
  
  if (attempts >= sArr.length) {
      studentIndex = 0;
  }
  
  let currentRotationIndex = studentIndex; 
  
  for(let w=0; w<weeks; w++){
    const sd = new Date(base.getFullYear(), base.getMonth(), base.getDate() + w*7);
    const ed = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate() + 6);
    
    const vacationPeriod = getVacationOverlap(sd, ed);
    if(vacationPeriod){
        const type = vacationPeriod.type;
        const note = vacationPeriod.note || (type === 'holiday' ? 'Školní prázdniny' : 'Ředitelské volno'); 
        const studentText = type === 'holiday' ? 'PRÁZDNINY' : 'VOLNO ŘEDITELE';
        const assignedType = type === 'holiday' ? 'VACATION' : 'DIRECTOR_FREE';
        
        out.push({start: sd, end: ed, student: studentText, note: note, type: assignedType, vacationPeriod});
        continue; 
    }
    
    let studentObj = sArr[currentRotationIndex % sArr.length];
    attempts = 0;
    
    while(isStatusActive(studentObj, sd) && attempts < sArr.length){
      currentRotationIndex++;
      studentObj = sArr[currentRotationIndex % sArr.length];
      attempts++;
    }
    
    if(attempts >= sArr.length) {
        studentObj = sArr[currentRotationIndex % sArr.length]; 
    } else {
        currentRotationIndex++;
    }

    out.push({start: sd, end: ed, student: studentObj.name, note: studentObj.note || '', type: 'ASSIGNMENT'});
  }
  return out;
}

/* render table */
let currentAssignments = [];
function renderAssignmentsTable(assigns){
  currentAssignments = assigns;
  const tbody = $('tableBody');
  tbody.innerHTML = '';
  const now = new Date();

  assigns.forEach((row, idx)=>{
    const tr = document.createElement('tr');
    
    const isCurrentWeek = now >= row.start && now <= row.end;
    if(isCurrentWeek){ tr.style.background = 'rgba(25, 99, 235, 0.1)'; }
    if(isCurrentWeek && document.body.getAttribute('data-theme') === 'dark'){
        tr.style.background = 'rgba(25, 99, 235, 0.2)';
    }

    const td1 = document.createElement('td'); td1.textContent = formatDate(row.start);
    const td2 = document.createElement('td'); td2.textContent = formatDate(row.end);
    
    const td3 = document.createElement('td'); 
    const td4_rating = document.createElement('td');
    const td5 = document.createElement('td');
    
    if(row.type === 'VACATION' || row.type === 'DIRECTOR_FREE'){
        const isVacation = row.type === 'VACATION';
        const badgeClass = isVacation ? 'warning' : 'info';
        const badgeIcon = isVacation ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-school-flag"></i>';
        
        td3.innerHTML = `<span class="badge ${badgeClass}">${badgeIcon} ${row.student}</span>`;
        td4_rating.textContent = '-';
        
        td5.textContent = row.vacationPeriod.note || row.note; 

        if (document.body.getAttribute('data-theme') === 'dark') {
            tr.style.background = isVacation ? 'rgba(245, 158, 11, 0.2)' : 'rgba(96, 165, 250, 0.2)';
        } else {
            tr.style.background = isVacation ? 'rgba(255, 204, 0, 0.1)' : 'rgba(96, 165, 250, 0.1)'; 
        }
        
    } else {
        td3.textContent = row.student;

        if(isCurrentWeek){
            const stars = document.createElement('div'); stars.className='stars';
            const r = store.ratings[row.student] || 0;
            for(let k=1;k<=5;k++){
                const i = document.createElement('i'); i.className = 'star fa fa-star ' + (k<=r ? '' : 'inactive');
                i.dataset.index = idx; // Použito pro získání poznámky
                i.onclick = (e)=>{ 
                    // Uložení poznámky před hodnocením - potřeba najít správný prvek
                    const noteElement = document.querySelector(`#tableBody tr:nth-child(${idx + 1}) input[data-index="${idx}"]`);
                    if(noteElement) row.note = noteElement.value;
                    e.stopPropagation(); 
                    setRating(row.student, k); 
                }; 
                stars.appendChild(i);
            }
            td4_rating.appendChild(stars);
        } else {
            td4_rating.textContent = (store.ratings[row.student] || 0) + ' / 5';
        }

        const noteIn = document.createElement('input'); noteIn.type='text'; noteIn.placeholder='Poznámka...';
        noteIn.style.padding='6px'; noteIn.style.borderRadius='6px'; noteIn.style.border='1px solid var(--border)';
        noteIn.value = row.note || '';
        noteIn.dataset.index = idx; 
        noteIn.onchange = (e)=>{ row.note = e.target.value; };
        td5.appendChild(noteIn);
    }

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4_rating); tr.appendChild(td5);
    tbody.appendChild(tr);
  });
}
/* utilities (omitted for brevity, assume unchanged logic) */
function pickColor(seed){
  const colors = ['#f97316','#ef4444','#f59e0b','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#14b8a6'];
  let s=0; for(let i=0;i<seed.length;i++) s += seed.charCodeAt(i);
  return colors[s % colors.length];
}
function shadeColor(hex, percent){
  const col = hex.replace('#','');
  const num = parseInt(col,16);
  let r = (num >> 16) + Math.round(255 * percent / 100);
  let g = ((num >> 8) & 0x00FF) + Math.round(255 * percent / 100);
  let b = (num & 0x0000FF) + Math.round(255 * percent / 100);
  r=Math.max(0,Math.min(255,r)); g=Math.max(0,Math.min(255,g)); b=Math.max(0,Math.min(255,b));
  return '#' + ( (1<<24) + (r<<16) + (g<<8) + b ).toString(16).slice(1);
}
/* other functions (exportPNG, sendEmail, applySort, computeStats, applyFilter, generateNow, renderVacationPeriods, openVacationModal, saveVacationProfile, addVacationPeriod, deleteVacationPeriod, clearAll, exportAllJSON, importAllJSON, addStudent, redrawAll - OMITTED FOR BREVITY, ASSUME UNCHANGED LOGIC) */

/* settings - VACATION (NOVÁ LOGIKA PRO PROFILY) */
let currentVacation = null;

function renderVacationPeriods(){
    const listContainer = $('vacationList');
    listContainer.innerHTML = '';
    
    const sortedPeriods = [...store.vacationPeriods].sort((a, b) => new Date(a.from) - new Date(b.from));

    if(sortedPeriods.length === 0){
        listContainer.innerHTML = '<p class="muted" style="text-align:center; margin-top:15px;">Žádné prázdniny ani volno není nastaveno.</p>';
        return;
    }

    sortedPeriods.forEach((period) => {
        const item = document.createElement('div');
        item.className = 'vacation-item';
        item.onclick = () => openVacationModal(period); 
        
        const typeText = period.type === 'holiday' ? 'Školní prázdniny' : 'Ředitelské volno';
        const typeBadgeClass = period.type === 'holiday' ? 'warning' : 'info';
        const icon = period.type === 'holiday' ? '<i class="fa fa-sun"></i>' : '<i class="fa fa-school-flag"></i>';
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'info';

        const titleLine = document.createElement('div');
        titleLine.className = 'title-text';
        titleLine.innerHTML = `${icon} ${typeText} <span class="badge ${typeBadgeClass}" style="margin-left:8px;">${period.type === 'holiday' ? 'Prázdniny' : 'Volno'}</span>`;
        infoDiv.appendChild(titleLine);

        const dates = document.createElement('div');
        dates.className = 'dates';
        dates.textContent = `${formatDate(period.from)} – ${formatDate(period.to)}`;
        infoDiv.appendChild(dates);

        if(period.note){
            const note = document.createElement('div');
            note.className = 'muted';
            note.textContent = `Poznámka: ${period.note}`;
            infoDiv.appendChild(note);
        }

        item.appendChild(infoDiv);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn danger action-small';
        deleteBtn.innerHTML = '<i class="fa fa-trash"></i> Smazat';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteVacationPeriod(period); };
        item.appendChild(deleteBtn);

        listContainer.appendChild(item);
    });
}

function openVacationModal(period){
    currentVacation = period; 
    if(!currentVacation) return;

    const titleText = currentVacation.type === 'holiday' ? 'Úprava prázdnin' : 'Úprava ředitelského volna';
    const typeText = currentVacation.type === 'holiday' ? 'Školní prázdniny' : 'Ředitelské volno';
    const badgeClass = currentVacation.type === 'holiday' ? 'warning' : 'info';

    $('modalVacationTitle').innerHTML = `<i class="fa fa-calendar-check"></i> ${titleText}`;
    $('modalVacationTypeBadge').innerHTML = `<span class="badge ${badgeClass}">${typeText}</span>`;
    
    $('modalVacationFrom').value = currentVacation.from;
    $('modalVacationTo').value = currentVacation.to;
    $('modalVacationNote').value = currentVacation.note || '';

    $('modalVacationDeleteBtn').onclick = () => {
        if(!confirm(`Opravdu smazat volno ${formatDate(currentVacation.from)} - ${formatDate(currentVacation.to)}?`)) return;
        deleteVacationPeriod(currentVacation);
        closeModal('vacationModal');
    };

    $('vacationModal').style.display = 'flex';
}

function saveVacationProfile(){
    if(!currentVacation) return;

    const newFrom = $('modalVacationFrom').value;
    const newTo = $('modalVacationTo').value;
    const newNote = $('modalVacationNote').value.trim();

    if(!newFrom || !newTo){
        alert('Musíš vybrat datum OD i datum DO.');
        return;
    }
    if(new Date(newFrom) >= new Date(newTo)){
        alert('Datum "Od" musí být dříve než datum "Do".');
        return;
    }

    currentVacation.from = newFrom;
    currentVacation.to = newTo;
    currentVacation.note = newNote;
    
    saveStore();
    closeModal('vacationModal');
    redrawAll(); 
}

function addVacationPeriod(){
    const type = $('vacationType').value;
    const from = $('vacationFrom').value;
    const to = $('vacationTo').value;

    if(!from || !to){
        alert('Musíš vybrat datum OD i datum DO.');
        return;
    }
    if(new Date(from) >= new Date(to)){
        alert('Datum "Od" musí být dříve než datum "Do".');
        return;
    }
    
    if(store.vacationPeriods.some(p => p.from === from && p.to === to && p.type === type)){
        alert('Toto období je již přidáno s tímto typem.');
        return;
    }

    store.vacationPeriods.push({ from, to, type, note: '' }); 
    saveStore();
    renderVacationPeriods();
    generateNow(); 
    
    $('vacationFrom').value = '';
    $('vacationTo').value = '';
}

function deleteVacationPeriod(period){
    const index = store.vacationPeriods.findIndex(p => p.from === period.from && p.to === period.to && p.type === period.type);
    if(index > -1) {
        store.vacationPeriods.splice(index, 1);
    } else {
        store.vacationPeriods = store.vacationPeriods.filter(p => !(p.from === period.from && p.to === period.to && p.type === period.type));
    }

    saveStore();
    renderVacationPeriods();
    generateNow(); 
}
function clearAll(){
  if(!confirm('Opravdu vymazat všechna data?')) return;
  localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_RATING); localStorage.removeItem(LS_VACATION);
  store = {students:[], ratings:{}, vacationPeriods: []};
  redrawAll();
}
function exportAllJSON(){
  const dataToExport = {
      students: store.students,
      ratings: store.ratings,
      vacationPeriods: store.vacationPeriods, 
  };
  const blob = new Blob([JSON.stringify(dataToExport,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'uklid_data.json'; a.click();
}

function importAllJSON(event){
    const file = event.target.files[0];
    if (!file) return;

    if(!confirm('Opravdu nahrát data z JSON souboru? Stávající data budou PŘEPSÁNA.')) {
        event.target.value = ''; 
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e){
        try{
            const data = JSON.parse(e.target.result);
            const importedVacation = data.vacationPeriods || (data.vacation && data.vacation.from && data.vacation.to ? [{...data.vacation, type:'holiday', note: data.vacation.note || ''}] : []);
            
            if(data.students && data.ratings && Array.isArray(importedVacation)){
                store.students = data.students;
                store.ratings = data.ratings;
                store.vacationPeriods = importedVacation;
                saveStore();
                redrawAll();
                alert('Data byla úspěšně nahrána a uložena.');
            } else {
                alert('Chyba: JSON soubor neobsahuje potřebná data nebo má chybný formát.');
            }
        } catch(err){
            alert('Chyba při zpracování JSON souboru: ' + err.message);
        }
        event.target.value = ''; 
    };
    reader.readAsText(file);
}
function redrawAll(){
  loadStore();
  todayShort();
  if(!store.students) store.students = [];
  if(!store.ratings) store.ratings = {};
  if(!store.vacationPeriods) store.vacationPeriods = []; 
  renderStudentsList();
  renderVacationPeriods(); 
  
  const now = new Date();
  if(!$('genFrom').value) $('genFrom').value = now.toISOString().slice(0,10);
  const tom = new Date(now.getFullYear(), now.getMonth(), now.getDate()+28);
  if(!$('filterFrom').value) $('filterFrom').value = now.toISOString().slice(0,10);
  if(!$('filterTo').value) $('filterTo').value = tom.toISOString().slice(0,10);
  if(!$('statFrom').value) $('statFrom').value = now.toISOString().slice(0,10);
  if(!$('statTo').value) $('statTo').value = tom.toISOString().slice(0,10);

  const weeks = Math.max(4, store.students.length);
  const assigns = generateAssignmentsFor(new Date(), weeks);
  renderAssignmentsTable(assigns);
  renderRatings();
}
function addStudent(){
  const val = $('newStudent').value.trim();
  if(!val) return alert('Zadej jméno žáka.');
  if((store.students||[]).some(s=>s.name.toLowerCase()===val.toLowerCase())){ alert('Tento žák je již v seznamu.'); return; }
  store.students.push({name: val, note: '', status: {}});
  saveStore();
  $('newStudent').value='';
  redrawAll();
}

/* theme & starfield animation (rest of the file remains the same) */
let starfieldCtx = null;
let stars = [];
let starAnimId = null;

const devicePixelRatio = window.devicePixelRatio || 1;

function initStarfield(){
  const c = document.getElementById('starfield');
  if (!c) return; 
  
  c.width = window.innerWidth * devicePixelRatio;
  c.height = window.innerHeight * devicePixelRatio;
  c.style.width = window.innerWidth + 'px';
  c.style.height = window.innerHeight + 'px';
  starfieldCtx = c.getContext('2d');
  starfieldCtx.scale(devicePixelRatio, devicePixelRatio);
  
  // init stars
  stars = [];
  const count = Math.round(window.innerWidth / 12);
  for(let i=0;i<count;i++){
    stars.push({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      r: Math.random() * 1.2 + 0.3,
      vx: (Math.random()-0.5)*0.02,
      vy: (Math.random()-0.5)*0.02,
      twinkle: Math.random()*1.5,
      // Přidání vrstev (depth) pro paralaxu při scrollování
      depth: Math.random() * 2 + 1, // 1 (nejblíže) až 3 (nejdále)
    });
  }
}
let scrollOffset = 0;

function animateStarfield(time){
  if(!starfieldCtx) return;
  starfieldCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
  starfieldCtx.globalCompositeOperation = 'lighter';
  stars.forEach(s=>{
    // Pohyb hvězdy v čase (pomalejší, aby se nepletl s paralaxou)
    s.x += s.vx * 0.2 * (1 + Math.sin(time/1000 + s.twinkle));
    s.y += s.vy * 0.2 * (1 + Math.cos(time/1100 + s.twinkle));
    
    // Započtení Scroll Parallaxy
    const scrollYAdjusted = scrollOffset / s.depth;
    
    // Vykreslení s paralaxou
    let drawY = s.y + scrollYAdjusted;
    
    // Zpětné posouvání do viditelného okna, aby hvězdy nevymizely
    if(s.x < 0) s.x = window.innerWidth;
    if(s.x > window.innerWidth) s.x = 0;
    
    // Použijeme modulo pro Y, abychom simulovali nekonečné pozadí při scrollování
    drawY = drawY % (window.innerHeight * 2); 
    if(drawY < -window.innerHeight) drawY += window.innerHeight * 2;
    if(drawY > window.innerHeight) drawY -= window.innerHeight * 2;
    
    const g = starfieldCtx.createRadialGradient(s.x, drawY, 0, s.x, drawY, s.r*6);
    g.addColorStop(0, 'rgba(255,255,255,0.95)');
    g.addColorStop(0.2, 'rgba(255,255,255,0.6)');
    g.addColorStop(1, 'rgba(255,255,255,0.0)');
    starfieldCtx.fillStyle = g;
    starfieldCtx.beginPath();
    starfieldCtx.arc(s.x, drawY, s.r*3, 0, Math.PI*2);
    starfieldCtx.fill();
  });
  starAnimId = requestAnimationFrame(animateStarfield);
}
function startStarfield(){ 
    if(!starfieldCtx) initStarfield(); 
    if(!starAnimId) starAnimId = requestAnimationFrame(animateStarfield); 
}
function stopStarfield(){ 
    if(starAnimId){ 
        cancelAnimationFrame(starAnimId); 
        starAnimId = null; 
        const c = document.getElementById('starfield'); 
        if(c && starfieldCtx){ 
            starfieldCtx.clearRect(0,0,c.width,c.height); 
        } 
    } 
}

/* toggle theme */
function toggleTheme(){
  const body = document.body;
  const t = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
  body.setAttribute('data-theme', t);
  updateThemeButton(t);
  if(t === 'dark'){ 
    initStarfield();
    startStarfield(); 
  } else { 
    stopStarfield(); 
  }
}

function updateThemeButton(theme){
    const btn = $('themeBtn');
    if(!btn) return;
    if(theme === 'dark'){
        btn.innerHTML = '<i class="fa fa-sun"></i> Přepnout motiv';
    } else {
        btn.innerHTML = '<i class="fa fa-moon"></i> Přepnout motiv';
    }
}


/* init resize handlers for starfield */
window.addEventListener('resize', ()=>{ 
    if(document.body.getAttribute('data-theme')==='dark'){
        initStarfield(); 
    }
});

/* init mouse parallax for stars */
window.addEventListener('mousemove',(e)=>{
  if(!stars || stars.length===0 || document.body.getAttribute('data-theme') === 'light') return; 
  const cx = e.clientX / window.innerWidth - 0.5;
  const cy = e.clientY / window.innerHeight - 0.5;
  stars.forEach((s,i)=>{
    s.x += cx * 0.6 * (i%3===0 ? 0.6 : 0.2);
    s.y += cy * 0.6 * (i%3===0 ? 0.6 : 0.2);
  });
});

/* SCROLL PARALLAX - NOVÁ LOGIKA */
window.addEventListener('scroll', () => {
    if(document.body.getAttribute('data-theme') === 'dark'){
        // Uložení aktuálního scroll offsetu pro použití v animateStarfield
        scrollOffset = window.scrollY; 
    }
}, {passive: true});

/* init */
(function init(){
  loadStore();
  if(!store.students) store.students = [];
  if(!store.ratings) store.ratings = {};
  if(!store.vacationPeriods) store.vacationPeriods = []; 
  todayShort();
  redrawAll();
  
  const currentTheme = document.body.getAttribute('data-theme') || 'light';
  updateThemeButton(currentTheme);
  if(currentTheme === 'dark') {
      initStarfield();
      startStarfield(); 
  }
})();

</script>

</body>
</html>
